shadow$provide.module$node_modules$$babylonjs$core$Rendering$renderingGroup=function(global,require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});exports.RenderingGroup=void 0;var _smartArray=require("module$node_modules$$babylonjs$core$Misc$smartArray"),_mathVector=require("module$node_modules$$babylonjs$core$Maths$math_vector");class RenderingGroup{set opaqueSortCompareFn(value){this._opaqueSortCompareFn=value?value:RenderingGroup.PainterSortCompare;this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(value){this._alphaTestSortCompareFn=
value?value:RenderingGroup.PainterSortCompare;this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(value){this._transparentSortCompareFn=value?value:RenderingGroup.defaultTransparentSortCompare;this._renderTransparent=this._renderTransparentSorted}constructor(index,scene,opaqueSortCompareFn=null,alphaTestSortCompareFn=null,transparentSortCompareFn=null){this.index=index;this._opaqueSubMeshes=new _smartArray.SmartArray(256);this._transparentSubMeshes=new _smartArray.SmartArray(256);
this._alphaTestSubMeshes=new _smartArray.SmartArray(256);this._depthOnlySubMeshes=new _smartArray.SmartArray(256);this._particleSystems=new _smartArray.SmartArray(256);this._spriteManagers=new _smartArray.SmartArray(256);this._empty=!0;this._edgesRenderers=new _smartArray.SmartArrayNoDuplicate(16);this._scene=scene;this.opaqueSortCompareFn=opaqueSortCompareFn;this.alphaTestSortCompareFn=alphaTestSortCompareFn;this.transparentSortCompareFn=transparentSortCompareFn}render(customRenderFunction,renderSprites,
renderParticles,activeMeshes){if(customRenderFunction)customRenderFunction(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);else{customRenderFunction=this._scene.getEngine();0!==this._depthOnlySubMeshes.length&&(customRenderFunction.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),customRenderFunction.setColorWrite(!0));0!==this._opaqueSubMeshes.length&&this._renderOpaque(this._opaqueSubMeshes);0!==this._alphaTestSubMeshes.length&&
this._renderAlphaTest(this._alphaTestSubMeshes);var stencilState=customRenderFunction.getStencilBuffer();customRenderFunction.setStencilBuffer(!1);renderSprites&&this._renderSprites();renderParticles&&this._renderParticles(activeMeshes);if(this.onBeforeTransparentRendering)this.onBeforeTransparentRendering();if(0!==this._transparentSubMeshes.length||this._scene.useOrderIndependentTransparency)customRenderFunction.setStencilBuffer(stencilState),this._scene.useOrderIndependentTransparency?(renderSprites=
this._scene.depthPeelingRenderer.render(this._transparentSubMeshes),renderSprites.length&&this._renderTransparent(renderSprites)):this._renderTransparent(this._transparentSubMeshes),customRenderFunction.setAlphaMode(0);customRenderFunction.setStencilBuffer(!1);if(this._edgesRenderers.length){for(renderSprites=0;renderSprites<this._edgesRenderers.length;renderSprites++)this._edgesRenderers.data[renderSprites].render();customRenderFunction.setAlphaMode(0)}customRenderFunction.setStencilBuffer(stencilState)}}_renderOpaqueSorted(subMeshes){return RenderingGroup._RenderSorted(subMeshes,
this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(subMeshes){return RenderingGroup._RenderSorted(subMeshes,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(subMeshes){return RenderingGroup._RenderSorted(subMeshes,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(subMeshes,sortCompareFn,camera,transparent){let subIndex=0;var cameraPosition=camera?camera.globalPosition:RenderingGroup._ZeroVector;if(transparent)for(;subIndex<
subMeshes.length;subIndex++)camera=subMeshes.data[subIndex],camera._alphaIndex=camera.getMesh().alphaIndex,camera._distanceToCamera=_mathVector.Vector3.Distance(camera.getBoundingInfo().boundingSphere.centerWorld,cameraPosition);subMeshes=subMeshes.length===subMeshes.data.length?subMeshes.data:subMeshes.data.slice(0,subMeshes.length);sortCompareFn&&subMeshes.sort(sortCompareFn);sortCompareFn=subMeshes[0].getMesh().getScene();for(subIndex=0;subIndex<subMeshes.length;subIndex++)if(camera=subMeshes[subIndex],
!sortCompareFn._activeMeshesFrozenButKeepClipping||camera.isInFrustum(sortCompareFn._frustumPlanes))transparent&&(cameraPosition=camera.getMaterial())&&cameraPosition.needDepthPrePass&&(cameraPosition=cameraPosition.getScene().getEngine(),cameraPosition.setColorWrite(!1),cameraPosition.setAlphaMode(0),camera.render(!1),cameraPosition.setColorWrite(!0)),camera.render(transparent)}static defaultTransparentSortCompare(a,b){return a._alphaIndex>b._alphaIndex?1:a._alphaIndex<b._alphaIndex?-1:RenderingGroup.backToFrontSortCompare(a,
b)}static backToFrontSortCompare(a,b){return a._distanceToCamera<b._distanceToCamera?1:a._distanceToCamera>b._distanceToCamera?-1:0}static frontToBackSortCompare(a,b){return a._distanceToCamera<b._distanceToCamera?-1:a._distanceToCamera>b._distanceToCamera?1:0}static PainterSortCompare(a,b){a=a.getMesh();b=b.getMesh();return a.material&&b.material?a.material.uniqueId-b.material.uniqueId:a.uniqueId-b.uniqueId}prepare(){this._opaqueSubMeshes.reset();this._transparentSubMeshes.reset();this._alphaTestSubMeshes.reset();
this._depthOnlySubMeshes.reset();this._particleSystems.reset();this.prepareSprites();this._edgesRenderers.reset();this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose();this._transparentSubMeshes.dispose();this._alphaTestSubMeshes.dispose();this._depthOnlySubMeshes.dispose();this._particleSystems.dispose();this._spriteManagers.dispose();this._edgesRenderers.dispose()}dispatch(subMesh,mesh,material){void 0===mesh&&(mesh=subMesh.getMesh());void 0===material&&
(material=subMesh.getMaterial());null!==material&&void 0!==material&&(material.needAlphaBlendingForMesh(mesh)?this._transparentSubMeshes.push(subMesh):material.needAlphaTesting()?(material.needDepthPrePass&&this._depthOnlySubMeshes.push(subMesh),this._alphaTestSubMeshes.push(subMesh)):(material.needDepthPrePass&&this._depthOnlySubMeshes.push(subMesh),this._opaqueSubMeshes.push(subMesh)),mesh._renderingGroup=this,mesh._edgesRenderer&&mesh._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(mesh._edgesRenderer),
this._empty=!1)}dispatchSprites(spriteManager){this._spriteManagers.push(spriteManager);this._empty=!1}dispatchParticles(particleSystem){this._particleSystems.push(particleSystem);this._empty=!1}_renderParticles(activeMeshes){if(0!==this._particleSystems.length){var activeCamera=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let particleIndex=0;particleIndex<this._particleSystems.length;particleIndex++){const particleSystem=this._particleSystems.data[particleIndex];
if(0===(activeCamera&&activeCamera.layerMask&particleSystem.layerMask))continue;const emitter=particleSystem.emitter;emitter.position&&activeMeshes&&-1===activeMeshes.indexOf(emitter)||this._scene._activeParticles.addCount(particleSystem.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}}_renderSprites(){if(this._scene.spritesEnabled&&0!==this._spriteManagers.length){var activeCamera=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);
for(let id=0;id<this._spriteManagers.length;id++){const spriteManager=this._spriteManagers.data[id];0!==(activeCamera&&activeCamera.layerMask&spriteManager.layerMask)&&spriteManager.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}}exports.RenderingGroup=RenderingGroup;RenderingGroup._ZeroVector=_mathVector.Vector3.Zero()}
//# sourceMappingURL=module$node_modules$$babylonjs$core$Rendering$renderingGroup.js.map
