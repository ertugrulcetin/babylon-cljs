shadow$provide.module$node_modules$$babylonjs$core$Engines$thinEngine=function(global,require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});exports.ThinEngine=void 0;var _engineStore=require("module$node_modules$$babylonjs$core$Engines$engineStore"),_effect=require("module$node_modules$$babylonjs$core$Materials$effect"),_devTools=require("module$node_modules$$babylonjs$core$Misc$devTools"),_observable=require("module$node_modules$$babylonjs$core$Misc$observable"),_depthCullingState=
require("module$node_modules$$babylonjs$core$States$depthCullingState"),_stencilState=require("module$node_modules$$babylonjs$core$States$stencilState"),_alphaCullingState=require("module$node_modules$$babylonjs$core$States$alphaCullingState"),_internalTexture=require("module$node_modules$$babylonjs$core$Materials$Textures$internalTexture"),_logger=require("module$node_modules$$babylonjs$core$Misc$logger"),_domManagement=require("module$node_modules$$babylonjs$core$Misc$domManagement"),_webGLShaderProcessors=
require("module$node_modules$$babylonjs$core$Engines$WebGL$webGLShaderProcessors"),_webGL2ShaderProcessors=require("module$node_modules$$babylonjs$core$Engines$WebGL$webGL2ShaderProcessors"),_webGLDataBuffer=require("module$node_modules$$babylonjs$core$Meshes$WebGL$webGLDataBuffer"),_webGLPipelineContext=require("module$node_modules$$babylonjs$core$Engines$WebGL$webGLPipelineContext"),_performanceConfigurator=require("module$node_modules$$babylonjs$core$Engines$performanceConfigurator"),_webGLHardwareTexture=
require("module$node_modules$$babylonjs$core$Engines$WebGL$webGLHardwareTexture"),_drawWrapper=require("module$node_modules$$babylonjs$core$Materials$drawWrapper"),_stencilStateComposer=require("module$node_modules$$babylonjs$core$States$stencilStateComposer"),_shaderLanguage=require("module$node_modules$$babylonjs$core$Materials$shaderLanguage"),_precisionDate=require("module$node_modules$$babylonjs$core$Misc$precisionDate");class BufferPointer{}class ThinEngine{static get NpmPackage(){return"babylonjs@6.11.1"}static get Version(){return"6.11.1"}get description(){let description=
this.name+this.webGLVersion;this._caps.parallelShaderCompile&&(description+=" - Parallel shader compilation");return description}get name(){return this._name}set name(value){this._name=value}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return _effect.Effect.ShadersRepository}static set ShadersRepository(value){_effect.Effect.ShadersRepository=value}_getShaderProcessor(shaderLanguage){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(useReverse){useReverse!==
this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=useReverse,this._depthCullingState.depthFunc=useReverse?518:515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return 1<this.webGLVersion&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!(!this._caps.highPrecisionShaderSupported||!this._highPrecisionShadersAllowed)}get needPOTTextures(){return 2>this._webGLVersion||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(value){this._doNotHandleContextLost=
value}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(dimensions){this._framebufferDimensionsObject=dimensions}get currentViewport(){return this._cachedViewport}get emptyTexture(){this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1));return this._emptyTexture}get emptyTexture3D(){this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1));return this._emptyTexture3D}get emptyTexture2DArray(){this._emptyTexture2DArray||
(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1));return this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const faceData=new Uint8Array(4);this._emptyCubeTexture=this.createRawCubeTexture([faceData,faceData,faceData,faceData,faceData,faceData],1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(activate){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(mode){this._snapshotRenderingMode=
mode}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(width,height){if("undefined"===typeof document)return new OffscreenCanvas(width,height);const canvas=document.createElement("canvas");canvas.width=width;canvas.height=height;return canvas}createCanvas(width,height){return ThinEngine._CreateCanvas(width,height)}createCanvasImage(){return document.createElement("img")}constructor(canvasOrContext,antialias,options,adaptToDeviceRatio){var _a,_b,_c,_d,_e,_f,_g,_h,_j,_k,_l;this._name=
"WebGL";this.isFullscreen=this.forcePOTTextures=this._isDisposed=!1;this.cullBackFaces=null;this.renderEvenInBackground=!0;this.isNDCHalfZRange=this._useReverseDepthBuffer=this.validateShaderPrograms=this.preventCacheWipeBetweenFrames=!1;this.hasOriginBottomLeft=!0;this.disableUniformBuffers=!1;this.onDisposeObservable=new _observable.Observable;this._frameId=0;this._uniformBuffers=[];this._storageBuffers=[];this._webGLVersion=1;this._windowIsBackground=!1;this._highPrecisionShadersAllowed=!0;this._renderingQueueLaunched=
this._badDesktopOS=this._badOS=!1;this._activeRenderLoops=[];this.onContextLostObservable=new _observable.Observable;this.onContextRestoredObservable=new _observable.Observable;this.disableVertexArrayObjects=this._doNotHandleContextLost=this._contextWasLost=!1;this._colorWriteChanged=this._colorWrite=!0;this._depthCullingState=new _depthCullingState.DepthCullingState;this._stencilStateComposer=new _stencilStateComposer.StencilStateComposer;this._stencilState=new _stencilState.StencilState;this._alphaState=
new _alphaCullingState.AlphaState;this._alphaMode=1;this._alphaEquation=0;this._internalTexturesCache=[];this._renderTargetWrapperCache=[];this._activeChannel=0;this._currentTextureChannel=-1;this._boundTexturesCache={};this._compiledEffects={};this._vertexAttribArraysEnabled=[];this._uintIndicesCurrentlySet=!1;this._currentBoundBuffer=[];this._dummyFramebuffer=this._currentFramebuffer=null;this._currentBufferPointers=[];this._currentInstanceLocations=[];this._currentInstanceBuffers=[];this._mustWipeVertexAttributes=
this._vaoRecordInProgress=!1;this._nextFreeTextureSlots=[];this._maxSimultaneousTextures=0;this._maxMSAASamplesOverride=null;this._activeRequests=[];this.adaptToDeviceRatio=!1;this._lastDevicePixelRatio=1;this._transformTextureUrl=null;this.hostInformation={isMobile:!1};this.premultipliedAlpha=!0;this.onBeforeTextureInitObservable=new _observable.Observable;this._isWebGPU=!1;this._snapshotRenderingMode=0;this._viewportCached={x:0,y:0,z:0,w:0};this._unpackFlipYCached=null;this.enableUnpackFlipYCached=
!0;this._boundUniforms={};this.startTime=_precisionDate.PrecisionDate.Now;var canvas=null;this._creationOptions=options=options||{};this.adaptToDeviceRatio=null!==adaptToDeviceRatio&&void 0!==adaptToDeviceRatio?adaptToDeviceRatio:!1;this._stencilStateComposer.stencilGlobal=this._stencilState;_performanceConfigurator.PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);options.antialias=null!==antialias&&void 0!==antialias?antialias:options.antialias;options.deterministicLockstep=
null!==(_a=options.deterministicLockstep)&&void 0!==_a?_a:!1;options.lockstepMaxSteps=null!==(_b=options.lockstepMaxSteps)&&void 0!==_b?_b:4;options.timeStep=null!==(_c=options.timeStep)&&void 0!==_c?_c:1/60;options.audioEngine=null!==(_d=options.audioEngine)&&void 0!==_d?_d:!0;options.stencil=null!==(_e=options.stencil)&&void 0!==_e?_e:!0;this._audioContext=null!==(_g=null===(_f=options.audioEngineOptions)||void 0===_f?void 0:_f.audioContext)&&void 0!==_g?_g:null;this._audioDestination=null!==(_j=
null===(_h=options.audioEngineOptions)||void 0===_h?void 0:_h.audioDestination)&&void 0!==_j?_j:null;this.premultipliedAlpha=null!==(_k=options.premultipliedAlpha)&&void 0!==_k?_k:!0;this.useExactSrgbConversions=null!==(_l=options.useExactSrgbConversions)&&void 0!==_l?_l:!1;this._doNotHandleContextLost=!!options.doNotHandleContextLost;this._isStencilEnable=options.stencil?!0:!1;adaptToDeviceRatio=adaptToDeviceRatio||options.adaptToDeviceRatio||!1;canvas=(0,_domManagement.IsWindowObjectExist)()?window.devicePixelRatio||
1:1;antialias=options.limitDeviceRatio||canvas;this._hardwareScalingLevel=adaptToDeviceRatio?1/Math.min(antialias,canvas):1;this._lastDevicePixelRatio=canvas;if(canvasOrContext){if(canvasOrContext.getContext){this._renderingCanvas=canvas=canvasOrContext;void 0===options.preserveDrawingBuffer&&(options.preserveDrawingBuffer=!1);void 0===options.xrCompatible&&(options.xrCompatible=!0);if(navigator&&navigator.userAgent){this._setupMobileChecks();canvasOrContext=navigator.userAgent;for(var exception of ThinEngine.ExceptionList)if(adaptToDeviceRatio=
exception.targets,(new RegExp(exception.key)).test(canvasOrContext)){if(exception.capture&&exception.captureConstraint&&(antialias=exception.captureConstraint,(_a=(new RegExp(exception.capture)).exec(canvasOrContext))&&0<_a.length&&parseInt(_a[_a.length-1])>=antialias))continue;for(const target of adaptToDeviceRatio)switch(target){case "uniformBuffer":this.disableUniformBuffers=!0;break;case "vao":this.disableVertexArrayObjects=!0;break;case "antialias":options.antialias=!1;break;case "maxMSAASamples":this._maxMSAASamplesOverride=
1}}}this._doNotHandleContextLost||(this._onContextLost=evt=>{evt.preventDefault();this._contextWasLost=!0;_logger.Logger.Warn("WebGL context lost.");this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},canvas.addEventListener("webglcontextlost",this._onContextLost,!1),canvas.addEventListener("webglcontextrestored",this._onContextRestored,!1),options.powerPreference=options.powerPreference||"high-performance");
if(this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent))options.xrCompatible=!1;if(!options.disableWebGL2Support)try{if(this._gl=canvas.getContext("webgl2",options)||canvas.getContext("experimental-webgl2",options))this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1")}catch(e){}if(!this._gl){if(!canvas)throw Error("The provided canvas is null or undefined.");try{this._gl=canvas.getContext("webgl",
options)||canvas.getContext("experimental-webgl",options)}catch(e){throw Error("WebGL not supported");}}if(!this._gl)throw Error("WebGL not supported");}else if(this._gl=canvasOrContext,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1",exception=this._gl.getContextAttributes())options.stencil=exception.stencil;this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE);
void 0!==options.useHighPrecisionFloats&&(this._highPrecisionShadersAllowed=options.useHighPrecisionFloats);this.resize();this._initGLContext();this._initFeatures();for(options=0;options<this._caps.maxVertexAttribs;options++)this._currentBufferPointers[options]=new BufferPointer;this._shaderProcessor=1<this.webGLVersion?new _webGL2ShaderProcessors.WebGL2ShaderProcessor:new _webGLShaderProcessors.WebGLShaderProcessor;this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);
options=`Babylon.js v${ThinEngine.Version}`;console.log(options+` - ${this.description}`);this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",options)}}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{const currentUA=navigator.userAgent;this.hostInformation.isMobile=-1!==currentUA.indexOf("Mobile")||-1!==currentUA.indexOf("Mac")&&(0,_domManagement.IsDocumentAvailable)()&&"ontouchend"in document},this._checkForMobile(),
(0,_domManagement.IsWindowObjectExist)()&&window.addEventListener("resize",this._checkForMobile))}_restoreEngineAfterContextLost(initEngine){setTimeout(async()=>{var _a;this._dummyFramebuffer=null;const depthTest=this._depthCullingState.depthTest,depthFunc=this._depthCullingState.depthFunc,depthMask=this._depthCullingState.depthMask,stencilTest=this._stencilState.stencilTest;await initEngine();this.wipeCaches(!0);this._rebuildEffects();null===(_a=this._rebuildComputeEffects)||void 0===_a?void 0:_a.call(this);
this._rebuildBuffers();this._rebuildInternalTextures();this._rebuildRenderTargetWrappers();this.wipeCaches(!0);this._depthCullingState.depthTest=depthTest;this._depthCullingState.depthFunc=depthFunc;this._depthCullingState.depthMask=depthMask;this._stencilState.stencilTest=stencilTest;_logger.Logger.Warn(this.name+" context successfully restored.");this.onContextRestoredObservable.notifyObservers(this);this._contextWasLost=!1},0)}_sharedInit(canvas){this._renderingCanvas=canvas}_getShaderProcessingContext(shaderLanguage){return null}_rebuildInternalTextures(){const currentState=
this._internalTexturesCache.slice();for(const internalTexture of currentState)internalTexture._rebuild()}_rebuildRenderTargetWrappers(){const currentState=this._renderTargetWrapperCache.slice();for(const renderTargetWrapper of currentState)renderTargetWrapper._rebuild()}_rebuildEffects(){for(const key in this._compiledEffects){const effect=this._compiledEffects[key];effect._pipelineContext=null;effect._wasPreviouslyReady=!1;effect._prepareEffect()}_effect.Effect.ResetCache()}areAllEffectsReady(){for(const key in this._compiledEffects)if(!this._compiledEffects[key].isReady())return!1;
return!0}_rebuildBuffers(){for(const uniformBuffer of this._uniformBuffers)uniformBuffer._rebuild();for(const storageBuffer of this._storageBuffers)storageBuffer._rebuild()}_initGLContext(){var _a;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),
maxSamples:1<this._webGLVersion?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),
parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:1<this._webGLVersion||null!==this._gl.getExtension("OES_standard_derivatives"),maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||
this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||
this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:1<this._webGLVersion||null!==this._gl.getExtension("OES_element_index_uint"),fragmentDepthSupported:1<this._webGLVersion||null!==this._gl.getExtension("EXT_frag_depth"),
highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:1<this._webGLVersion,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(1<this._webGLVersion&&this._gl.getExtension("EXT_color_buffer_float")),colorBufferHalfFloat:!!(1<this._webGLVersion&&this._gl.getExtension("EXT_color_buffer_half_float")),textureFloat:1<this._webGLVersion||this._gl.getExtension("OES_texture_float")?
!0:!1,textureHalfFloat:1<this._webGLVersion||this._gl.getExtension("OES_texture_half_float")?!0:!1,textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:1<this._webGLVersion||this._gl.getExtension("EXT_shader_texture_lod")?!0:!1,texelFetch:1!==this._webGLVersion,blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,
canUseGLInstanceID:1<this._webGLVersion,canUseGLVertexID:1<this._webGLVersion,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:1<this._webGLVersion,textureMaxLevel:1<this._webGLVersion,texture2DArrayMaxLayerCount:1<this._webGLVersion?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1};this._glVersion=this._gl.getParameter(this._gl.VERSION);var rendererInfo=this._gl.getExtension("WEBGL_debug_renderer_info");null!=rendererInfo&&(this._glRenderer=
this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL));this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor");this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer");36193!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=36193);34842!==this._gl.RGBA16F&&(this._gl.RGBA16F=34842);34836!==this._gl.RGBA32F&&(this._gl.RGBA32F=34836);35056!==this._gl.DEPTH24_STENCIL8&&
(this._gl.DEPTH24_STENCIL8=35056);this._caps.timerQuery&&(1===this._webGLVersion&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=0<(null!==(_a=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))&&void 0!==_a?_a:0));this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):
0;this._caps.textureFloatLinearFiltering=this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")?!0:!1;this._caps.textureFloatRender=this._caps.textureFloat&&this._canRenderToFloatFramebuffer()?!0:!1;this._caps.textureHalfFloatLinearFiltering=1<this._webGLVersion||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")?!0:!1;this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR);this._caps.bptc&&
(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT);this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT);this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,
this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC);1<this._webGLVersion&&5131!==this._gl.HALF_FLOAT_OES&&(this._gl.HALF_FLOAT_OES=5131);this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer();if(1<this._webGLVersion)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=null!==this._maxMSAASamplesOverride?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else if(_a=this._gl.getExtension("WEBGL_draw_buffers"),
null!==_a)for(this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=_a.drawBuffersWEBGL.bind(_a),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER,rendererInfo=0;16>rendererInfo;rendererInfo++)this._gl["COLOR_ATTACHMENT"+rendererInfo+"_WEBGL"]=_a["COLOR_ATTACHMENT"+rendererInfo+"_WEBGL"];1<this._webGLVersion?this._caps.depthTextureExtension=!0:(_a=this._gl.getExtension("WEBGL_depth_texture"),null!=_a&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=_a.UNSIGNED_INT_24_8_WEBGL));this.disableVertexArrayObjects?
this._caps.vertexArrayObject=!1:1<this._webGLVersion?this._caps.vertexArrayObject=!0:(_a=this._gl.getExtension("OES_vertex_array_object"),null!=_a&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=_a.createVertexArrayOES.bind(_a),this._gl.bindVertexArray=_a.bindVertexArrayOES.bind(_a),this._gl.deleteVertexArray=_a.deleteVertexArrayOES.bind(_a)));1<this._webGLVersion?this._caps.instancedArrays=!0:(_a=this._gl.getExtension("ANGLE_instanced_arrays"),null!=_a?(this._caps.instancedArrays=!0,
this._gl.drawArraysInstanced=_a.drawArraysInstancedANGLE.bind(_a),this._gl.drawElementsInstanced=_a.drawElementsInstancedANGLE.bind(_a),this._gl.vertexAttribDivisor=_a.vertexAttribDivisorANGLE.bind(_a)):this._caps.instancedArrays=!1);this._gl.getShaderPrecisionFormat&&(_a=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),rendererInfo=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT),_a&&rendererInfo&&(this._caps.highPrecisionShaderSupported=
0!==_a.precision&&0!==rendererInfo.precision));1<this._webGLVersion?this._caps.blendMinMax=!0:(_a=this._gl.getExtension("EXT_blend_minmax"),null!=_a&&(this._caps.blendMinMax=!0,this._gl.MAX=_a.MAX_EXT,this._gl.MIN=_a.MIN_EXT));this._caps.supportSRGBBuffers||(1<this._webGLVersion?(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:WebGL2RenderingContext.SRGB,SRGB8:WebGL2RenderingContext.SRGB8,SRGB8_ALPHA8:WebGL2RenderingContext.SRGB8_ALPHA8}):(_a=this._gl.getExtension("EXT_sRGB"),null!=
_a&&(this._caps.supportSRGBBuffers=!0,this._glSRGBExtensionValues={SRGB:_a.SRGB_EXT,SRGB8:_a.SRGB_ALPHA_EXT,SRGB8_ALPHA8:_a.SRGB_ALPHA_EXT})),this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!(!this._creationOptions||!this._creationOptions.forceSRGBBufferSupportState));this._depthCullingState.depthTest=!0;this._depthCullingState.depthFunc=this._gl.LEQUAL;this._depthCullingState.depthMask=!0;this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(_a=0;_a<this._maxSimultaneousTextures;_a++)this._nextFreeTextureSlots.push(_a);
"Mali-G72"===this._glRenderer&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:1!==this._webGLVersion,supportDepthStencilTexture:1!==this._webGLVersion,supportShadowSamplers:1!==this._webGLVersion,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:1!==this._webGLVersion,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:1!==this._webGLVersion,basisNeedsPOT:1===this._webGLVersion,
support3DTextures:1!==this._webGLVersion,needTypeSuffixInShaderConstants:1!==this._webGLVersion,supportMSAA:1!==this._webGLVersion,supportSSAO2:1!==this._webGLVersion,supportExtendedTextureFormats:1!==this._webGLVersion,supportSwitchCaseInShader:1!==this._webGLVersion,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(!this._workingCanvas){this._workingCanvas=
this.createCanvas(1,1);var context=this._workingCanvas.getContext("2d");context&&(this._workingContext=context)}}resetTextureCache(){for(const key in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,key)&&(this._boundTexturesCache[key]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(level){this._hardwareScalingLevel=level;
this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(renderFunction){renderFunction?(renderFunction=this._activeRenderLoops.indexOf(renderFunction),0<=renderFunction&&this._activeRenderLoops.splice(renderFunction,1)):this._activeRenderLoops.length=0}_renderLoop(){if(!this._contextWasLost){var shouldRender=!0;if(this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)shouldRender=
!1;if(shouldRender){this.beginFrame();for(shouldRender=0;shouldRender<this._activeRenderLoops.length;shouldRender++)(0,this._activeRenderLoops[shouldRender])();this.endFrame()}}0<this._activeRenderLoops.length?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return(0,_domManagement.IsWindowObjectExist)()?
this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(useScreen=!1){return!useScreen&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(useScreen=!1){return!useScreen&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?
this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(bindedRenderFunction,requester){return ThinEngine.QueueNewFrame(bindedRenderFunction,requester)}runRenderLoop(renderFunction){-1===this._activeRenderLoops.indexOf(renderFunction)&&(this._activeRenderLoops.push(renderFunction),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,
this.getHostWindow())))}clear(color,backBuffer,depth,stencil=!1){var useStencilGlobalOnly=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0;this.applyStates();this.stencilStateComposer.useStencilGlobalOnly=useStencilGlobalOnly;useStencilGlobalOnly=0;backBuffer&&color&&(this._gl.clearColor(color.r,color.g,color.b,void 0!==color.a?color.a:1),useStencilGlobalOnly|=this._gl.COLOR_BUFFER_BIT);depth&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=
this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),useStencilGlobalOnly|=this._gl.DEPTH_BUFFER_BIT);stencil&&(this._gl.clearStencil(0),useStencilGlobalOnly|=this._gl.STENCIL_BUFFER_BIT);this._gl.clear(useStencilGlobalOnly)}_viewport(x,y,width,height){if(x!==this._viewportCached.x||y!==this._viewportCached.y||width!==this._viewportCached.z||height!==this._viewportCached.w)this._viewportCached.x=x,this._viewportCached.y=y,this._viewportCached.z=width,this._viewportCached.w=height,this._gl.viewport(x,
y,width,height)}setViewport(viewport,requiredWidth,requiredHeight){requiredWidth=requiredWidth||this.getRenderWidth();requiredHeight=requiredHeight||this.getRenderHeight();const x=viewport.x||0,y=viewport.y||0;this._cachedViewport=viewport;this._viewport(x*requiredWidth,y*requiredHeight,requiredWidth*viewport.width,requiredHeight*viewport.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer();this._frameId++}resize(forceSetSize=!1){if(this.adaptToDeviceRatio){var width=(0,_domManagement.IsWindowObjectExist)()?
window.devicePixelRatio||1:1;var height=this._lastDevicePixelRatio/width;this._lastDevicePixelRatio=width;this._hardwareScalingLevel*=height}(0,_domManagement.IsWindowObjectExist)()&&(0,_domManagement.IsDocumentAvailable)()?this._renderingCanvas?(height=this._renderingCanvas.getBoundingClientRect?this._renderingCanvas.getBoundingClientRect():{width:this._renderingCanvas.width*this._hardwareScalingLevel,height:this._renderingCanvas.height*this._hardwareScalingLevel},width=this._renderingCanvas.clientWidth||
height.width||this._renderingCanvas.width||100,height=this._renderingCanvas.clientHeight||height.height||this._renderingCanvas.height||100):(width=window.innerWidth,height=window.innerHeight):(width=this._renderingCanvas?this._renderingCanvas.width:100,height=this._renderingCanvas?this._renderingCanvas.height:100);this.setSize(width/this._hardwareScalingLevel,height/this._hardwareScalingLevel,forceSetSize)}setSize(width,height,forceSetSize=!1){if(!this._renderingCanvas)return!1;width|=0;height|=0;
if(!forceSetSize&&this._renderingCanvas.width===width&&this._renderingCanvas.height===height)return!1;this._renderingCanvas.width=width;this._renderingCanvas.height=height;return!0}bindFramebuffer(rtWrapper,faceIndex=0,requiredWidth,requiredHeight,forceFullscreenViewport,lodLevel=0,layer=0){var _a,_b,_c,_d,_e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget);this._currentRenderTarget=rtWrapper;this._bindUnboundFramebuffer(rtWrapper._MSAAFramebuffer?rtWrapper._MSAAFramebuffer:
rtWrapper._framebuffer);const gl=this._gl;rtWrapper.isMulti||(rtWrapper.is2DArray?gl.framebufferTextureLayer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,null===(_a=rtWrapper.texture._hardwareTexture)||void 0===_a?void 0:_a.underlyingResource,lodLevel,layer):rtWrapper.isCube&&gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex,null===(_b=rtWrapper.texture._hardwareTexture)||void 0===_b?void 0:_b.underlyingResource,lodLevel));if(_a=rtWrapper._depthStencilTexture)_b=
rtWrapper._depthStencilTextureWithStencil?gl.DEPTH_STENCIL_ATTACHMENT:gl.DEPTH_ATTACHMENT,rtWrapper.is2DArray?gl.framebufferTextureLayer(gl.FRAMEBUFFER,_b,null===(_c=_a._hardwareTexture)||void 0===_c?void 0:_c.underlyingResource,lodLevel,layer):rtWrapper.isCube?gl.framebufferTexture2D(gl.FRAMEBUFFER,_b,gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex,null===(_d=_a._hardwareTexture)||void 0===_d?void 0:_d.underlyingResource,lodLevel):gl.framebufferTexture2D(gl.FRAMEBUFFER,_b,gl.TEXTURE_2D,null===(_e=_a._hardwareTexture)||
void 0===_e?void 0:_e.underlyingResource,lodLevel);this._cachedViewport&&!forceFullscreenViewport?this.setViewport(this._cachedViewport,requiredWidth,requiredHeight):(requiredWidth||(requiredWidth=rtWrapper.width,lodLevel&&(requiredWidth/=Math.pow(2,lodLevel))),requiredHeight||(requiredHeight=rtWrapper.height,lodLevel&&(requiredHeight/=Math.pow(2,lodLevel))),this._viewport(0,0,requiredWidth,requiredHeight));this.wipeCaches()}setState(culling,zOffset=0,force,reverseSide=!1,cullBackFaces,stencil,zOffsetUnits=
0){var _a,_b;if(this._depthCullingState.cull!==culling||force)this._depthCullingState.cull=culling;culling=(null!==(_b=null!==(_a=this.cullBackFaces)&&void 0!==_a?_a:cullBackFaces)&&void 0!==_b?_b:1)?this._gl.BACK:this._gl.FRONT;if(this._depthCullingState.cullFace!==culling||force)this._depthCullingState.cullFace=culling;this.setZOffset(zOffset);this.setZOffsetUnits(zOffsetUnits);zOffset=reverseSide?this._gl.CW:this._gl.CCW;if(this._depthCullingState.frontFace!==zOffset||force)this._depthCullingState.frontFace=
zOffset;this._stencilStateComposer.stencilMaterial=stencil}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(enable){this._depthCullingState.depthTest=enable}setZOffset(value){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-value:value}getZOffset(){const zOffset=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-zOffset:zOffset}setZOffsetUnits(value){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-value:value}getZOffsetUnits(){const zOffsetUnits=
this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-zOffsetUnits:zOffsetUnits}_bindUnboundFramebuffer(framebuffer){this._currentFramebuffer!==framebuffer&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,framebuffer),this._currentFramebuffer=framebuffer)}_currentFrameBufferIsDefaultFrameBuffer(){return null===this._currentFramebuffer}generateMipmaps(texture){this._bindTextureDirectly(this._gl.TEXTURE_2D,texture,!0);this._gl.generateMipmap(this._gl.TEXTURE_2D);this._bindTextureDirectly(this._gl.TEXTURE_2D,
null)}unBindFramebuffer(texture,disableGenerateMipMaps=!1,onBeforeUnbind){var _a;this._currentRenderTarget=null;const gl=this._gl;if(texture._MSAAFramebuffer){if(texture.isMulti){this.unBindMultiColorAttachmentFramebuffer(texture,disableGenerateMipMaps,onBeforeUnbind);return}gl.bindFramebuffer(gl.READ_FRAMEBUFFER,texture._MSAAFramebuffer);gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER,texture._framebuffer);gl.blitFramebuffer(0,0,texture.width,texture.height,0,0,texture.width,texture.height,gl.COLOR_BUFFER_BIT,
gl.NEAREST)}(null===(_a=texture.texture)||void 0===_a?0:_a.generateMipMaps)&&!disableGenerateMipMaps&&!texture.isCube&&this.generateMipmaps(texture.texture);onBeforeUnbind&&(texture._MSAAFramebuffer&&this._bindUnboundFramebuffer(texture._framebuffer),onBeforeUnbind());this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null);this._cachedViewport&&
this.setViewport(this._cachedViewport);this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null);this._cachedVertexBuffers=null}createVertexBuffer(data){return this._createVertexBuffer(data,this._gl.STATIC_DRAW)}_createVertexBuffer(data,usage){var vbo=this._gl.createBuffer();if(!vbo)throw Error("Unable to create vertex buffer");vbo=new _webGLDataBuffer.WebGLDataBuffer(vbo);this.bindArrayBuffer(vbo);data instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(data),
usage):this._gl.bufferData(this._gl.ARRAY_BUFFER,data,usage);this._resetVertexBufferBinding();vbo.references=1;return vbo}createDynamicVertexBuffer(data){return this._createVertexBuffer(data,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null);this._cachedIndexBuffer=null}createIndexBuffer(indices,updatable){const vbo=this._gl.createBuffer(),dataBuffer=new _webGLDataBuffer.WebGLDataBuffer(vbo);if(!vbo)throw Error("Unable to create index buffer");this.bindIndexBuffer(dataBuffer);
indices=this._normalizeIndexData(indices);this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,indices,updatable?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW);this._resetIndexBufferBinding();dataBuffer.references=1;dataBuffer.is32Bits=4===indices.BYTES_PER_ELEMENT;return dataBuffer}_normalizeIndexData(indices){if(2===indices.BYTES_PER_ELEMENT)return indices;if(this._caps.uintIndices){if(indices instanceof Uint32Array)return indices;for(let index=0;index<indices.length;index++)if(65535<=indices[index])return new Uint32Array(indices)}return new Uint16Array(indices)}bindArrayBuffer(buffer){this._vaoRecordInProgress||
this._unbindVertexArrayObject();this._bindBuffer(buffer,this._gl.ARRAY_BUFFER)}bindUniformBlock(pipelineContext,blockName,index){pipelineContext=pipelineContext.program;blockName=this._gl.getUniformBlockIndex(pipelineContext,blockName);this._gl.uniformBlockBinding(pipelineContext,blockName,index)}bindIndexBuffer(buffer){this._vaoRecordInProgress||this._unbindVertexArrayObject();this._bindBuffer(buffer,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(buffer,target){if(this._vaoRecordInProgress||this._currentBoundBuffer[target]!==
buffer)this._gl.bindBuffer(target,buffer?buffer.underlyingResource:null),this._currentBoundBuffer[target]=buffer}updateArrayBuffer(data){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,data)}_vertexAttribPointer(buffer,indx,size,type,normalized,stride,offset){const pointer=this._currentBufferPointers[indx];if(pointer){var changed=!1;pointer.active?(pointer.buffer!==buffer&&(pointer.buffer=buffer,changed=!0),pointer.size!==size&&(pointer.size=size,changed=!0),pointer.type!==type&&(pointer.type=type,
changed=!0),pointer.normalized!==normalized&&(pointer.normalized=normalized,changed=!0),pointer.stride!==stride&&(pointer.stride=stride,changed=!0),pointer.offset!==offset&&(pointer.offset=offset,changed=!0)):(changed=!0,pointer.active=!0,pointer.index=indx,pointer.size=size,pointer.type=type,pointer.normalized=normalized,pointer.stride=stride,pointer.offset=offset,pointer.buffer=buffer);if(changed||this._vaoRecordInProgress)this.bindArrayBuffer(buffer),type===this._gl.UNSIGNED_INT||type===this._gl.INT?
this._gl.vertexAttribIPointer(indx,size,type,stride,offset):this._gl.vertexAttribPointer(indx,size,type,normalized,stride,offset)}}_bindIndexBufferWithCache(indexBuffer){null!=indexBuffer&&this._cachedIndexBuffer!==indexBuffer&&(this._cachedIndexBuffer=indexBuffer,this.bindIndexBuffer(indexBuffer),this._uintIndicesCurrentlySet=indexBuffer.is32Bits)}_bindVertexBuffersAttributes(vertexBuffers,effect,overrideVertexBuffers){const attributes=effect.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject();
this.unbindAllAttributes();for(let index=0;index<attributes.length;index++){const order=effect.getAttributeLocation(index);if(0<=order){var ai=attributes[index];let vertexBuffer=null;overrideVertexBuffers&&(vertexBuffer=overrideVertexBuffers[ai]);vertexBuffer||(vertexBuffer=vertexBuffers[ai]);vertexBuffer&&(this._gl.enableVertexAttribArray(order),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[order]=!0),ai=vertexBuffer.getBuffer())&&(this._vertexAttribPointer(ai,order,vertexBuffer.getSize(),
vertexBuffer.type,vertexBuffer.normalized,vertexBuffer.byteStride,vertexBuffer.byteOffset),vertexBuffer.getIsInstanced()&&(this._gl.vertexAttribDivisor(order,vertexBuffer.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(order),this._currentInstanceBuffers.push(ai))))}}}recordVertexArrayObject(vertexBuffers,indexBuffer,effect,overrideVertexBuffers){const vao=this._gl.createVertexArray();if(!vao)throw Error("Unable to create VAO");this._vaoRecordInProgress=!0;this._gl.bindVertexArray(vao);
this._mustWipeVertexAttributes=!0;this._bindVertexBuffersAttributes(vertexBuffers,effect,overrideVertexBuffers);this.bindIndexBuffer(indexBuffer);this._vaoRecordInProgress=!1;this._gl.bindVertexArray(null);return vao}bindVertexArrayObject(vertexArrayObject,indexBuffer){this._cachedVertexArrayObject!==vertexArrayObject&&(this._cachedVertexArrayObject=vertexArrayObject,this._gl.bindVertexArray(vertexArrayObject),this._cachedIndexBuffer=this._cachedVertexBuffers=null,this._uintIndicesCurrentlySet=null!=
indexBuffer&&indexBuffer.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(vertexBuffer,indexBuffer,vertexDeclaration,vertexStrideSize,effect){if(this._cachedVertexBuffers!==vertexBuffer||this._cachedEffectForVertexBuffers!==effect){this._cachedVertexBuffers=vertexBuffer;this._cachedEffectForVertexBuffers=effect;const attributesCount=effect.getAttributesCount();this._unbindVertexArrayObject();this.unbindAllAttributes();let offset=0;for(let index=0;index<attributesCount;index++)if(index<
vertexDeclaration.length){const order=effect.getAttributeLocation(index);0<=order&&(this._gl.enableVertexAttribArray(order),this._vertexAttribArraysEnabled[order]=!0,this._vertexAttribPointer(vertexBuffer,order,vertexDeclaration[index],this._gl.FLOAT,!1,vertexStrideSize,offset));offset+=4*vertexDeclaration[index]}}this._bindIndexBufferWithCache(indexBuffer)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(vertexBuffers,
indexBuffer,effect,overrideVertexBuffers){if(this._cachedVertexBuffers!==vertexBuffers||this._cachedEffectForVertexBuffers!==effect)this._cachedVertexBuffers=vertexBuffers,this._cachedEffectForVertexBuffers=effect,this._bindVertexBuffersAttributes(vertexBuffers,effect,overrideVertexBuffers);this._bindIndexBufferWithCache(indexBuffer)}unbindInstanceAttributes(){let boundBuffer;for(let i=0,ul=this._currentInstanceLocations.length;i<ul;i++){const instancesBuffer=this._currentInstanceBuffers[i];boundBuffer!=
instancesBuffer&&instancesBuffer.references&&(boundBuffer=instancesBuffer,this.bindArrayBuffer(instancesBuffer));this._gl.vertexAttribDivisor(this._currentInstanceLocations[i],0)}this._currentInstanceBuffers.length=0;this._currentInstanceLocations.length=0}releaseVertexArrayObject(vao){this._gl.deleteVertexArray(vao)}_releaseBuffer(buffer){buffer.references--;return 0===buffer.references?(this._deleteBuffer(buffer),!0):!1}_deleteBuffer(buffer){this._gl.deleteBuffer(buffer.underlyingResource)}updateAndBindInstancesBuffer(instancesBuffer,
data,offsetLocations){this.bindArrayBuffer(instancesBuffer);data&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,data);if(void 0!==offsetLocations[0].index)this.bindInstancesBuffer(instancesBuffer,offsetLocations,!0);else for(data=0;4>data;data++){const offsetLocation=offsetLocations[data];this._vertexAttribArraysEnabled[offsetLocation]||(this._gl.enableVertexAttribArray(offsetLocation),this._vertexAttribArraysEnabled[offsetLocation]=!0);this._vertexAttribPointer(instancesBuffer,offsetLocation,4,
this._gl.FLOAT,!1,64,16*data);this._gl.vertexAttribDivisor(offsetLocation,1);this._currentInstanceLocations.push(offsetLocation);this._currentInstanceBuffers.push(instancesBuffer)}}bindInstancesBuffer(instancesBuffer,attributesInfo,computeStride=!0){this.bindArrayBuffer(instancesBuffer);let stride=0;if(computeStride)for(computeStride=0;computeStride<attributesInfo.length;computeStride++)stride+=4*attributesInfo[computeStride].attributeSize;for(computeStride=0;computeStride<attributesInfo.length;computeStride++){const ai=
attributesInfo[computeStride];void 0===ai.index&&(ai.index=this._currentEffect.getAttributeLocationByName(ai.attributeName));0>ai.index||(this._vertexAttribArraysEnabled[ai.index]||(this._gl.enableVertexAttribArray(ai.index),this._vertexAttribArraysEnabled[ai.index]=!0),this._vertexAttribPointer(instancesBuffer,ai.index,ai.attributeSize,ai.attributeType||this._gl.FLOAT,ai.normalized||!1,stride,ai.offset),this._gl.vertexAttribDivisor(ai.index,void 0===ai.divisor?1:ai.divisor),this._currentInstanceLocations.push(ai.index),
this._currentInstanceBuffers.push(instancesBuffer))}}disableInstanceAttributeByName(name){this._currentEffect&&(name=this._currentEffect.getAttributeLocationByName(name),this.disableInstanceAttribute(name))}disableInstanceAttribute(attributeLocation){let shouldClean=!1,index;for(;-1!==(index=this._currentInstanceLocations.indexOf(attributeLocation));)this._currentInstanceLocations.splice(index,1),this._currentInstanceBuffers.splice(index,1),shouldClean=!0,this._currentInstanceLocations.indexOf(attributeLocation);
shouldClean&&(this._gl.vertexAttribDivisor(attributeLocation,0),this.disableAttributeByIndex(attributeLocation))}disableAttributeByIndex(attributeLocation){this._gl.disableVertexAttribArray(attributeLocation);this._vertexAttribArraysEnabled[attributeLocation]=!1;this._currentBufferPointers[attributeLocation].active=!1}draw(useTriangles,indexStart,indexCount,instancesCount){this.drawElementsType(useTriangles?0:1,indexStart,indexCount,instancesCount)}drawPointClouds(verticesStart,verticesCount,instancesCount){this.drawArraysType(2,
verticesStart,verticesCount,instancesCount)}drawUnIndexed(useTriangles,verticesStart,verticesCount,instancesCount){this.drawArraysType(useTriangles?0:1,verticesStart,verticesCount,instancesCount)}drawElementsType(fillMode,indexStart,indexCount,instancesCount){this.applyStates();this._reportDrawCall();fillMode=this._drawMode(fillMode);const indexFormat=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,mult=this._uintIndicesCurrentlySet?4:2;instancesCount?this._gl.drawElementsInstanced(fillMode,
indexCount,indexFormat,indexStart*mult,instancesCount):this._gl.drawElements(fillMode,indexCount,indexFormat,indexStart*mult)}drawArraysType(fillMode,verticesStart,verticesCount,instancesCount){this.applyStates();this._reportDrawCall();fillMode=this._drawMode(fillMode);instancesCount?this._gl.drawArraysInstanced(fillMode,verticesStart,verticesCount,instancesCount):this._gl.drawArrays(fillMode,verticesStart,verticesCount)}_drawMode(fillMode){switch(fillMode){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;
case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(effect){this._compiledEffects[effect._key]&&delete this._compiledEffects[effect._key];(effect=effect.getPipelineContext())&&this._deletePipelineContext(effect)}_deletePipelineContext(pipelineContext){pipelineContext&&
pipelineContext.program&&(pipelineContext.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(pipelineContext.program))}_getGlobalDefines(defines){if(defines)this.isNDCHalfZRange?defines.IS_NDC_HALF_ZRANGE="":delete defines.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?defines.USE_REVERSE_DEPTHBUFFER="":delete defines.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?defines.USE_EXACT_SRGB_CONVERSIONS="":delete defines.USE_EXACT_SRGB_CONVERSIONS;else return defines="",this.isNDCHalfZRange&&
(defines+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(defines&&(defines+="\n"),defines+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(defines&&(defines+="\n"),defines+="#define USE_EXACT_SRGB_CONVERSIONS"),defines}createEffect(baseName,attributesNamesOrOptions,uniformsNamesOrEngine,samplers,defines,fallbacks,onCompiled,onError,indexParameters,shaderLanguage=_shaderLanguage.ShaderLanguage.GLSL){var _a;const vertex=baseName.vertexElement||baseName.vertex||baseName.vertexToken||
baseName.vertexSource||baseName,fragment=baseName.fragmentElement||baseName.fragment||baseName.fragmentToken||baseName.fragmentSource||baseName,globalDefines=this._getGlobalDefines();let fullDefines=null!==(_a=null!==defines&&void 0!==defines?defines:attributesNamesOrOptions.defines)&&void 0!==_a?_a:"";globalDefines&&(fullDefines+=globalDefines);_a=vertex+"+"+fragment+"@"+fullDefines;if(this._compiledEffects[_a])return baseName=this._compiledEffects[_a],onCompiled&&baseName.isReady()&&onCompiled(baseName),
baseName;onCompiled=new _effect.Effect(baseName,attributesNamesOrOptions,uniformsNamesOrEngine,samplers,this,defines,fallbacks,onCompiled,onError,indexParameters,_a,shaderLanguage);return this._compiledEffects[_a]=onCompiled}static _ConcatenateShader(source,defines,shaderVersion=""){return shaderVersion+(defines?defines+"\n":"")+source}_compileShader(source,type,defines,shaderVersion){return this._compileRawShader(ThinEngine._ConcatenateShader(source,defines,shaderVersion),type)}_compileRawShader(source,
type){const gl=this._gl;var shader=gl.createShader("vertex"===type?gl.VERTEX_SHADER:gl.FRAGMENT_SHADER);if(!shader){for(source=gl.NO_ERROR;(shader=gl.getError())!==gl.NO_ERROR;)source=shader;throw Error(`Something went wrong while creating a gl ${type} shader object. gl error=${source}, gl isContextLost=${gl.isContextLost()}, _contextWasLost=${this._contextWasLost}`);}gl.shaderSource(shader,source);gl.compileShader(shader);return shader}_getShaderSource(shader){return this._gl.getShaderSource(shader)}createRawShaderProgram(pipelineContext,
vertexCode,fragmentCode,context,transformFeedbackVaryings=null){context=context||this._gl;vertexCode=this._compileRawShader(vertexCode,"vertex");fragmentCode=this._compileRawShader(fragmentCode,"fragment");return this._createShaderProgram(pipelineContext,vertexCode,fragmentCode,context,transformFeedbackVaryings)}createShaderProgram(pipelineContext,vertexCode,fragmentCode,defines,context,transformFeedbackVaryings=null){context=context||this._gl;const shaderVersion=1<this._webGLVersion?"#version 300 es\n#define WEBGL2 \n":
"";vertexCode=this._compileShader(vertexCode,"vertex",defines,shaderVersion);fragmentCode=this._compileShader(fragmentCode,"fragment",defines,shaderVersion);return this._createShaderProgram(pipelineContext,vertexCode,fragmentCode,context,transformFeedbackVaryings)}inlineShaderCode(code){return code}createPipelineContext(shaderProcessingContext){shaderProcessingContext=new _webGLPipelineContext.WebGLPipelineContext;shaderProcessingContext.engine=this;this._caps.parallelShaderCompile&&(shaderProcessingContext.isParallelCompiled=
!0);return shaderProcessingContext}createMaterialContext(){}createDrawContext(){}_createShaderProgram(pipelineContext,vertexShader,fragmentShader,context,transformFeedbackVaryings){transformFeedbackVaryings=context.createProgram();pipelineContext.program=transformFeedbackVaryings;if(!transformFeedbackVaryings)throw Error("Unable to create program");context.attachShader(transformFeedbackVaryings,vertexShader);context.attachShader(transformFeedbackVaryings,fragmentShader);context.linkProgram(transformFeedbackVaryings);
pipelineContext.context=context;pipelineContext.vertexShader=vertexShader;pipelineContext.fragmentShader=fragmentShader;pipelineContext.isParallelCompiled||this._finalizePipelineContext(pipelineContext);return transformFeedbackVaryings}_finalizePipelineContext(pipelineContext){const context=pipelineContext.context,vertexShader=pipelineContext.vertexShader,fragmentShader=pipelineContext.fragmentShader;var program=pipelineContext.program;if(!context.getProgramParameter(program,context.LINK_STATUS)){if(!this._gl.getShaderParameter(vertexShader,
this._gl.COMPILE_STATUS)){var log=this._gl.getShaderInfoLog(vertexShader);if(log)throw pipelineContext.vertexCompilationError=log,Error("VERTEX SHADER "+log);}if(!this._gl.getShaderParameter(fragmentShader,this._gl.COMPILE_STATUS)&&(log=this._gl.getShaderInfoLog(fragmentShader)))throw pipelineContext.fragmentCompilationError=log,Error("FRAGMENT SHADER "+log);if(log=context.getProgramInfoLog(program))throw pipelineContext.programLinkError=log,Error(log);}if(this.validateShaderPrograms&&(context.validateProgram(program),
!context.getProgramParameter(program,context.VALIDATE_STATUS)&&(program=context.getProgramInfoLog(program))))throw pipelineContext.programValidationError=program,Error(program);context.deleteShader(vertexShader);context.deleteShader(fragmentShader);pipelineContext.vertexShader=void 0;pipelineContext.fragmentShader=void 0;pipelineContext.onCompiled&&(pipelineContext.onCompiled(),pipelineContext.onCompiled=void 0)}_preparePipelineContext(pipelineContext,vertexSourceCode,fragmentSourceCode,createAsRaw,
rawVertexSourceCode,rawFragmentSourceCode,rebuildRebind,defines,transformFeedbackVaryings,key){pipelineContext.program=createAsRaw?this.createRawShaderProgram(pipelineContext,vertexSourceCode,fragmentSourceCode,void 0,transformFeedbackVaryings):this.createShaderProgram(pipelineContext,vertexSourceCode,fragmentSourceCode,defines,void 0,transformFeedbackVaryings);pipelineContext.program.__SPECTOR_rebuildProgram=rebuildRebind}_isRenderingStateCompiled(pipelineContext){return this._isDisposed||pipelineContext._isDisposed?
!1:this._gl.getProgramParameter(pipelineContext.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(pipelineContext),!0):!1}_executeWhenRenderingStateIsCompiled(pipelineContext,action){if(pipelineContext.isParallelCompiled){var oldHandler=pipelineContext.onCompiled;pipelineContext.onCompiled=oldHandler?()=>{oldHandler();action()}:action}else action()}getUniforms(pipelineContext,uniformsNames){const results=[];for(let index=0;index<uniformsNames.length;index++)results.push(this._gl.getUniformLocation(pipelineContext.program,
uniformsNames[index]));return results}getAttributes(pipelineContext,attributesNames){const results=[];for(let index=0;index<attributesNames.length;index++)try{results.push(this._gl.getAttribLocation(pipelineContext.program,attributesNames[index]))}catch(e){results.push(-1)}return results}enableEffect(effect){if((effect=null!==effect&&_drawWrapper.DrawWrapper.IsWrapper(effect)?effect.effect:effect)&&effect!==this._currentEffect){this._stencilStateComposer.stencilMaterial=void 0;this.bindSamplers(effect);
this._currentEffect=effect;if(effect.onBind)effect.onBind(effect);effect._onBindObservable&&effect._onBindObservable.notifyObservers(effect)}}setInt(uniform,value){if(!uniform)return!1;this._gl.uniform1i(uniform,value);return!0}setInt2(uniform,x,y){if(!uniform)return!1;this._gl.uniform2i(uniform,x,y);return!0}setInt3(uniform,x,y,z){if(!uniform)return!1;this._gl.uniform3i(uniform,x,y,z);return!0}setInt4(uniform,x,y,z,w){if(!uniform)return!1;this._gl.uniform4i(uniform,x,y,z,w);return!0}setIntArray(uniform,
array){if(!uniform)return!1;this._gl.uniform1iv(uniform,array);return!0}setIntArray2(uniform,array){if(!uniform||0!==array.length%2)return!1;this._gl.uniform2iv(uniform,array);return!0}setIntArray3(uniform,array){if(!uniform||0!==array.length%3)return!1;this._gl.uniform3iv(uniform,array);return!0}setIntArray4(uniform,array){if(!uniform||0!==array.length%4)return!1;this._gl.uniform4iv(uniform,array);return!0}setUInt(uniform,value){if(!uniform)return!1;this._gl.uniform1ui(uniform,value);return!0}setUInt2(uniform,
x,y){if(!uniform)return!1;this._gl.uniform2ui(uniform,x,y);return!0}setUInt3(uniform,x,y,z){if(!uniform)return!1;this._gl.uniform3ui(uniform,x,y,z);return!0}setUInt4(uniform,x,y,z,w){if(!uniform)return!1;this._gl.uniform4ui(uniform,x,y,z,w);return!0}setUIntArray(uniform,array){if(!uniform)return!1;this._gl.uniform1uiv(uniform,array);return!0}setUIntArray2(uniform,array){if(!uniform||0!==array.length%2)return!1;this._gl.uniform2uiv(uniform,array);return!0}setUIntArray3(uniform,array){if(!uniform||
0!==array.length%3)return!1;this._gl.uniform3uiv(uniform,array);return!0}setUIntArray4(uniform,array){if(!uniform||0!==array.length%4)return!1;this._gl.uniform4uiv(uniform,array);return!0}setArray(uniform,array){if(!uniform||1>array.length)return!1;this._gl.uniform1fv(uniform,array);return!0}setArray2(uniform,array){if(!uniform||0!==array.length%2)return!1;this._gl.uniform2fv(uniform,array);return!0}setArray3(uniform,array){if(!uniform||0!==array.length%3)return!1;this._gl.uniform3fv(uniform,array);
return!0}setArray4(uniform,array){if(!uniform||0!==array.length%4)return!1;this._gl.uniform4fv(uniform,array);return!0}setMatrices(uniform,matrices){if(!uniform)return!1;this._gl.uniformMatrix4fv(uniform,!1,matrices);return!0}setMatrix3x3(uniform,matrix){if(!uniform)return!1;this._gl.uniformMatrix3fv(uniform,!1,matrix);return!0}setMatrix2x2(uniform,matrix){if(!uniform)return!1;this._gl.uniformMatrix2fv(uniform,!1,matrix);return!0}setFloat(uniform,value){if(!uniform)return!1;this._gl.uniform1f(uniform,
value);return!0}setFloat2(uniform,x,y){if(!uniform)return!1;this._gl.uniform2f(uniform,x,y);return!0}setFloat3(uniform,x,y,z){if(!uniform)return!1;this._gl.uniform3f(uniform,x,y,z);return!0}setFloat4(uniform,x,y,z,w){if(!uniform)return!1;this._gl.uniform4f(uniform,x,y,z,w);return!0}applyStates(){this._depthCullingState.apply(this._gl);this._stencilStateComposer.apply(this._gl);this._alphaState.apply(this._gl);if(this._colorWriteChanged){this._colorWriteChanged=!1;const enable=this._colorWrite;this._gl.colorMask(enable,
enable,enable,enable)}}setColorWrite(enable){enable!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=enable)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(bruteForce){if(!this.preventCacheWipeBetweenFrames||bruteForce)this._currentEffect=
null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),bruteForce&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWriteChanged=this._colorWrite=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,
this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedEffectForVertexBuffers=this._cachedIndexBuffer=null,this.bindIndexBuffer(null)}_getSamplingParameters(samplingMode,generateMipMaps){const gl=this._gl;let magFilter=gl.NEAREST,minFilter=gl.NEAREST;switch(samplingMode){case 11:magFilter=gl.LINEAR;minFilter=generateMipMaps?gl.LINEAR_MIPMAP_NEAREST:gl.LINEAR;break;case 3:magFilter=
gl.LINEAR;minFilter=generateMipMaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR;break;case 8:magFilter=gl.NEAREST;minFilter=generateMipMaps?gl.NEAREST_MIPMAP_LINEAR:gl.NEAREST;break;case 4:magFilter=gl.NEAREST;minFilter=generateMipMaps?gl.NEAREST_MIPMAP_NEAREST:gl.NEAREST;break;case 5:magFilter=gl.NEAREST;minFilter=generateMipMaps?gl.LINEAR_MIPMAP_NEAREST:gl.LINEAR;break;case 6:magFilter=gl.NEAREST;minFilter=generateMipMaps?gl.LINEAR_MIPMAP_LINEAR:gl.LINEAR;break;case 7:magFilter=gl.NEAREST;minFilter=gl.LINEAR;
break;case 1:minFilter=magFilter=gl.NEAREST;break;case 9:magFilter=gl.LINEAR;minFilter=generateMipMaps?gl.NEAREST_MIPMAP_NEAREST:gl.NEAREST;break;case 10:magFilter=gl.LINEAR;minFilter=generateMipMaps?gl.NEAREST_MIPMAP_LINEAR:gl.NEAREST;break;case 2:minFilter=magFilter=gl.LINEAR;break;case 12:magFilter=gl.LINEAR,minFilter=gl.NEAREST}return{min:minFilter,mag:magFilter}}_createTexture(){const texture=this._gl.createTexture();if(!texture)throw Error("Unable to create texture");return texture}_createHardwareTexture(){return new _webGLHardwareTexture.WebGLHardwareTexture(this._createTexture(),
this._gl)}_createInternalTexture(size,options,delayGPUTextureCreation,source=_internalTexture.InternalTextureSource.Unknown){var _a;let type=0,samplingMode=3,format=5,useSRGBBuffer=!1,samples=1,label;void 0!==options&&"object"===typeof options?(delayGPUTextureCreation=!!options.generateMipMaps,type=void 0===options.type?0:options.type,samplingMode=void 0===options.samplingMode?3:options.samplingMode,format=void 0===options.format?5:options.format,useSRGBBuffer=void 0===options.useSRGBBuffer?!1:options.useSRGBBuffer,
samples=null!==(_a=options.samples)&&void 0!==_a?_a:1,label=options.label):delayGPUTextureCreation=!!options;useSRGBBuffer&&(useSRGBBuffer=this._caps.supportSRGBBuffers&&(1<this.webGLVersion||this.isWebGPU));1!==type||this._caps.textureFloatLinearFiltering?2!==type||this._caps.textureHalfFloatLinearFiltering||(samplingMode=1):samplingMode=1;1!==type||this._caps.textureFloat||(type=0,_logger.Logger.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));options=this._gl;
source=new _internalTexture.InternalTexture(this,source);_a=size.width||size;const height=size.height||size;size=size.layers||0;const filters=this._getSamplingParameters(samplingMode,delayGPUTextureCreation),target=0!==size?options.TEXTURE_2D_ARRAY:options.TEXTURE_2D,sizedFormat=this._getRGBABufferInternalSizedFormat(type,format,useSRGBBuffer),internalFormat=this._getInternalFormat(format),textureType=this._getWebGLTextureType(type);this._bindTextureDirectly(target,source);0!==size?(source.is2DArray=
!0,options.texImage3D(target,0,sizedFormat,_a,height,size,0,internalFormat,textureType,null)):options.texImage2D(target,0,sizedFormat,_a,height,0,internalFormat,textureType,null);options.texParameteri(target,options.TEXTURE_MAG_FILTER,filters.mag);options.texParameteri(target,options.TEXTURE_MIN_FILTER,filters.min);options.texParameteri(target,options.TEXTURE_WRAP_S,options.CLAMP_TO_EDGE);options.texParameteri(target,options.TEXTURE_WRAP_T,options.CLAMP_TO_EDGE);delayGPUTextureCreation&&this._gl.generateMipmap(target);
this._bindTextureDirectly(target,null);source._useSRGBBuffer=useSRGBBuffer;source.baseWidth=_a;source.baseHeight=height;source.width=_a;source.height=height;source.depth=size;source.isReady=!0;source.samples=samples;source.generateMipMaps=delayGPUTextureCreation;source.samplingMode=samplingMode;source.type=type;source.format=format;source.label=label;this._internalTexturesCache.push(source);return source}_getUseSRGBBuffer(useSRGBBuffer,noMipmap){return useSRGBBuffer&&this._caps.supportSRGBBuffers&&
(1<this.webGLVersion||this.isWebGPU||noMipmap)}_createTextureBase(url,noMipmap,invertY,scene,samplingMode=3,onLoad=null,onError=null,prepareTexture,prepareTextureProcessFunction,buffer=null,fallback=null,format=null,forcedExtension=null,mimeType,loaderOptions,useSRGBBuffer){url=url||"";const fromData="data:"===url.substr(0,5),fromBlob="blob:"===url.substr(0,5),isBase64=fromData&&-1!==url.indexOf(";base64,"),texture=fallback?fallback:new _internalTexture.InternalTexture(this,_internalTexture.InternalTextureSource.Url);
texture!==fallback&&(texture.label=url.substring(0,60));const originalUrl=url;!this._transformTextureUrl||isBase64||fallback||buffer||(url=this._transformTextureUrl(url));originalUrl!==url&&(texture._originalUrl=originalUrl);const lastDot=url.lastIndexOf(".");let extension=forcedExtension?forcedExtension:-1<lastDot?url.substring(lastDot).toLowerCase():"",loader=null;-1<extension.indexOf("?")&&(extension=extension.split("?")[0]);for(const availableLoader of ThinEngine._TextureLoaders)if(availableLoader.canLoad(extension,
mimeType)){loader=availableLoader;break}scene&&scene.addPendingData(texture);texture.url=url;texture.generateMipMaps=!noMipmap;texture.samplingMode=samplingMode;texture.invertY=invertY;texture._useSRGBBuffer=this._getUseSRGBBuffer(!!useSRGBBuffer,noMipmap);this._doNotHandleContextLost||(texture._buffer=buffer);let onLoadObserver=null;onLoad&&!fallback&&(onLoadObserver=texture.onLoadedObservable.add(onLoad));fallback||this._internalTexturesCache.push(texture);const onInternalError=(message,exception)=>
{scene&&scene.removePendingData(texture);url===originalUrl?(onLoadObserver&&texture.onLoadedObservable.remove(onLoadObserver),_engineStore.EngineStore.UseFallbackTexture&&this._createTextureBase(_engineStore.EngineStore.FallbackTexture,noMipmap,texture.invertY,scene,samplingMode,null,onError,prepareTexture,prepareTextureProcessFunction,buffer,texture),message=(message||"Unknown error")+(_engineStore.EngineStore.UseFallbackTexture?" - Fallback texture was used":""),texture.onErrorObservable.notifyObservers({message,
exception}),onError&&onError(message,exception)):(_logger.Logger.Warn(`Failed to load ${url}, falling back to ${originalUrl}`),this._createTextureBase(originalUrl,noMipmap,texture.invertY,scene,samplingMode,onLoad,onError,prepareTexture,prepareTextureProcessFunction,buffer,texture,format,forcedExtension,mimeType,loaderOptions,useSRGBBuffer))};if(loader){const callback=data=>{loader.loadData(data,texture,(width,height,loadMipmap,isCompressed,done,loadFailed)=>{loadFailed?onInternalError("TextureLoader failed to load data"):
prepareTexture(texture,extension,scene,{width,height},texture.invertY,!loadMipmap,isCompressed,()=>{done();return!1},samplingMode)},loaderOptions)};buffer?buffer instanceof ArrayBuffer?callback(new Uint8Array(buffer)):ArrayBuffer.isView(buffer)?callback(buffer):onError&&onError("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(url,data=>callback(new Uint8Array(data)),void 0,scene?scene.offlineProvider:void 0,!0,(request,exception)=>{onInternalError("Unable to load "+
(request?request.responseURL:url,exception))})}else invertY=img=>{fromBlob&&!this._doNotHandleContextLost&&(texture._buffer=img);prepareTexture(texture,extension,scene,img,texture.invertY,noMipmap,!1,prepareTextureProcessFunction,samplingMode)},!fromData||isBase64?buffer&&("string"===typeof buffer.decoding||buffer.close)?invertY(buffer):ThinEngine._FileToolsLoadImage(url,invertY,onInternalError,scene?scene.offlineProvider:null,mimeType,texture.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:
void 0):"string"===typeof buffer||buffer instanceof ArrayBuffer||ArrayBuffer.isView(buffer)||buffer instanceof Blob?ThinEngine._FileToolsLoadImage(buffer,invertY,onInternalError,scene?scene.offlineProvider:null,mimeType,texture.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):buffer&&invertY(buffer);return texture}createTexture(url,noMipmap,invertY,scene,samplingMode=3,onLoad=null,onError=null,buffer=null,fallback=null,format=null,forcedExtension=null,mimeType,loaderOptions,
creationFlags,useSRGBBuffer){return this._createTextureBase(url,noMipmap,invertY,scene,samplingMode,onLoad,onError,this._prepareWebGLTexture.bind(this),(potWidth,potHeight,img,extension,texture,continuationCallback)=>{const gl=this._gl;var isPot=img.width===potWidth&&img.height===potHeight;const internalFormat=format?this._getInternalFormat(format,texture._useSRGBBuffer):".jpg"!==extension||texture._useSRGBBuffer?texture._useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:gl.RGBA:gl.RGB;extension=
format?this._getInternalFormat(format):".jpg"!==extension||texture._useSRGBBuffer?gl.RGBA:gl.RGB;texture._useSRGBBuffer&&1===this.webGLVersion&&(extension=internalFormat);if(isPot)return gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,extension,gl.UNSIGNED_BYTE,img),!1;isPot=this._caps.maxTextureSize;if(img.width>isPot||img.height>isPot||!this._supportsHardwareTextureRescaling){this._prepareWorkingCanvas();if(!this._workingCanvas||!this._workingContext)return!1;this._workingCanvas.width=potWidth;this._workingCanvas.height=
potHeight;this._workingContext.drawImage(img,0,0,img.width,img.height,0,0,potWidth,potHeight);gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,extension,gl.UNSIGNED_BYTE,this._workingCanvas);texture.width=potWidth;texture.height=potHeight;return!1}const source=new _internalTexture.InternalTexture(this,_internalTexture.InternalTextureSource.Temp);this._bindTextureDirectly(gl.TEXTURE_2D,source,!0);gl.texImage2D(gl.TEXTURE_2D,0,internalFormat,extension,gl.UNSIGNED_BYTE,img);this._rescaleTexture(source,texture,
scene,internalFormat,()=>{this._releaseTexture(source);this._bindTextureDirectly(gl.TEXTURE_2D,texture,!0);continuationCallback()});return!0},buffer,fallback,format,forcedExtension,mimeType,loaderOptions,useSRGBBuffer)}static _FileToolsLoadImage(input,onLoad,onError,offlineProvider,mimeType,imageBitmapOptions){throw(0,_devTools._WarnImport)("FileTools");}_rescaleTexture(source,destination,scene,internalFormat,onComplete){}createRawTexture(data,width,height,format,generateMipMaps,invertY,samplingMode,
compression,type,creationFlags,useSRGBBuffer){throw(0,_devTools._WarnImport)("Engine.RawTexture");}createRawCubeTexture(data,size,format,type,generateMipMaps,invertY,samplingMode,compression){throw(0,_devTools._WarnImport)("Engine.RawTexture");}createRawTexture3D(data,width,height,depth,format,generateMipMaps,invertY,samplingMode,compression,textureType){throw(0,_devTools._WarnImport)("Engine.RawTexture");}createRawTexture2DArray(data,width,height,depth,format,generateMipMaps,invertY,samplingMode,
compression,textureType){throw(0,_devTools._WarnImport)("Engine.RawTexture");}_unpackFlipY(value){this._unpackFlipYCached!==value&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,value?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=value))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(texture){return texture.isCube?this._gl.TEXTURE_CUBE_MAP:texture.is3D?this._gl.TEXTURE_3D:texture.is2DArray||texture.isMultiview?this._gl.TEXTURE_2D_ARRAY:
this._gl.TEXTURE_2D}updateTextureSamplingMode(samplingMode,texture,generateMipMaps=!1){const target=this._getTextureTarget(texture),filters=this._getSamplingParameters(samplingMode,texture.useMipMaps||generateMipMaps);this._setTextureParameterInteger(target,this._gl.TEXTURE_MAG_FILTER,filters.mag,texture);this._setTextureParameterInteger(target,this._gl.TEXTURE_MIN_FILTER,filters.min);generateMipMaps&&(texture.generateMipMaps=!0,this._gl.generateMipmap(target));this._bindTextureDirectly(target,null);
texture.samplingMode=samplingMode}updateTextureDimensions(texture,width,height,depth){}updateTextureWrappingMode(texture,wrapU,wrapV=null,wrapR=null){const target=this._getTextureTarget(texture);null!==wrapU&&(this._setTextureParameterInteger(target,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(wrapU),texture),texture._cachedWrapU=wrapU);null!==wrapV&&(this._setTextureParameterInteger(target,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(wrapV),texture),texture._cachedWrapV=wrapV);(texture.is2DArray||
texture.is3D)&&null!==wrapR&&(this._setTextureParameterInteger(target,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(wrapR),texture),texture._cachedWrapR=wrapR);this._bindTextureDirectly(target,null)}_setupDepthStencilTexture(internalTexture,size,generateStencil,bilinearFiltering,comparisonFunction,samples=1){generateStencil=size.width||size;const height=size.height||size;size=size.layers||0;internalTexture.baseWidth=generateStencil;internalTexture.baseHeight=height;internalTexture.width=generateStencil;
internalTexture.height=height;internalTexture.is2DArray=0<size;internalTexture.depth=size;internalTexture.isReady=!0;internalTexture.samples=samples;internalTexture.generateMipMaps=!1;internalTexture.samplingMode=bilinearFiltering?2:1;internalTexture.type=0;internalTexture._comparisonFunction=comparisonFunction;bilinearFiltering=this._gl;samples=this._getTextureTarget(internalTexture);internalTexture=this._getSamplingParameters(internalTexture.samplingMode,!1);bilinearFiltering.texParameteri(samples,
bilinearFiltering.TEXTURE_MAG_FILTER,internalTexture.mag);bilinearFiltering.texParameteri(samples,bilinearFiltering.TEXTURE_MIN_FILTER,internalTexture.min);bilinearFiltering.texParameteri(samples,bilinearFiltering.TEXTURE_WRAP_S,bilinearFiltering.CLAMP_TO_EDGE);bilinearFiltering.texParameteri(samples,bilinearFiltering.TEXTURE_WRAP_T,bilinearFiltering.CLAMP_TO_EDGE);1<this.webGLVersion&&(0===comparisonFunction?(bilinearFiltering.texParameteri(samples,bilinearFiltering.TEXTURE_COMPARE_FUNC,515),bilinearFiltering.texParameteri(samples,
bilinearFiltering.TEXTURE_COMPARE_MODE,bilinearFiltering.NONE)):(bilinearFiltering.texParameteri(samples,bilinearFiltering.TEXTURE_COMPARE_FUNC,comparisonFunction),bilinearFiltering.texParameteri(samples,bilinearFiltering.TEXTURE_COMPARE_MODE,bilinearFiltering.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(texture,internalFormat,width,height,data,faceIndex=0,lod=0){const gl=this._gl;let target=gl.TEXTURE_2D;texture.isCube&&(target=gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex);if(texture._useSRGBBuffer)switch(internalFormat){case 37492:case 36196:this._caps.etc2?
internalFormat=gl.COMPRESSED_SRGB8_ETC2:texture._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?internalFormat=gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:texture._useSRGBBuffer=!1;break;case 36492:internalFormat=gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:internalFormat=gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?internalFormat=gl.COMPRESSED_SRGB_S3TC_DXT1_EXT:texture._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?internalFormat=gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:
texture._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?internalFormat=gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:texture._useSRGBBuffer=!1;break;default:texture._useSRGBBuffer=!1}this._gl.compressedTexImage2D(target,lod,internalFormat,width,height,0,data)}_uploadDataToTextureDirectly(texture,imageData,faceIndex=0,lod=0,babylonInternalFormat,useTextureWidthAndHeight=!1){const gl=this._gl,textureType=this._getWebGLTextureType(texture.type),format=this._getInternalFormat(texture.format);babylonInternalFormat=
void 0===babylonInternalFormat?this._getRGBABufferInternalSizedFormat(texture.type,texture.format,texture._useSRGBBuffer):this._getInternalFormat(babylonInternalFormat,texture._useSRGBBuffer);this._unpackFlipY(texture.invertY);let target=gl.TEXTURE_2D;texture.isCube&&(target=gl.TEXTURE_CUBE_MAP_POSITIVE_X+faceIndex);faceIndex=Math.round(Math.log(texture.width)*Math.LOG2E);const lodMaxHeight=Math.round(Math.log(texture.height)*Math.LOG2E);gl.texImage2D(target,lod,babylonInternalFormat,useTextureWidthAndHeight?
texture.width:Math.pow(2,Math.max(faceIndex-lod,0)),useTextureWidthAndHeight?texture.height:Math.pow(2,Math.max(lodMaxHeight-lod,0)),0,format,textureType,imageData)}updateTextureData(texture,imageData,xOffset,yOffset,width,height,faceIndex=0,lod=0,generateMipMaps=!1){const gl=this._gl,textureType=this._getWebGLTextureType(texture.type),format=this._getInternalFormat(texture.format);this._unpackFlipY(texture.invertY);let targetForBinding=gl.TEXTURE_2D,target=gl.TEXTURE_2D;texture.isCube&&(target=gl.TEXTURE_CUBE_MAP_POSITIVE_X+
faceIndex,targetForBinding=gl.TEXTURE_CUBE_MAP);this._bindTextureDirectly(targetForBinding,texture,!0);gl.texSubImage2D(target,lod,xOffset,yOffset,width,height,format,textureType,imageData);generateMipMaps&&this._gl.generateMipmap(target);this._bindTextureDirectly(targetForBinding,null)}_uploadArrayBufferViewToTexture(texture,imageData,faceIndex=0,lod=0){var gl=this._gl;gl=texture.isCube?gl.TEXTURE_CUBE_MAP:gl.TEXTURE_2D;this._bindTextureDirectly(gl,texture,!0);this._uploadDataToTextureDirectly(texture,
imageData,faceIndex,lod);this._bindTextureDirectly(gl,null,!0)}_prepareWebGLTextureContinuation(texture,scene,noMipmap,isCompressed,samplingMode){const gl=this._gl;gl&&(samplingMode=this._getSamplingParameters(samplingMode,!noMipmap),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,samplingMode.mag),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,samplingMode.min),noMipmap||isCompressed||gl.generateMipmap(gl.TEXTURE_2D),this._bindTextureDirectly(gl.TEXTURE_2D,null),scene&&scene.removePendingData(texture),
texture.onLoadedObservable.notifyObservers(texture),texture.onLoadedObservable.clear())}_prepareWebGLTexture(texture,extension,scene,img,invertY,noMipmap,isCompressed,processFunction,samplingMode=3){var maxTextureSize=this.getCaps().maxTextureSize;const potWidth=Math.min(maxTextureSize,this.needPOTTextures?ThinEngine.GetExponentOfTwo(img.width,maxTextureSize):img.width);maxTextureSize=Math.min(maxTextureSize,this.needPOTTextures?ThinEngine.GetExponentOfTwo(img.height,maxTextureSize):img.height);const gl=
this._gl;gl&&(texture._hardwareTexture?(this._bindTextureDirectly(gl.TEXTURE_2D,texture,!0),this._unpackFlipY(void 0===invertY?!0:invertY?!0:!1),texture.baseWidth=img.width,texture.baseHeight=img.height,texture.width=potWidth,texture.height=maxTextureSize,texture.isReady=!0,processFunction(potWidth,maxTextureSize,img,extension,texture,()=>{this._prepareWebGLTextureContinuation(texture,scene,noMipmap,isCompressed,samplingMode)})||this._prepareWebGLTextureContinuation(texture,scene,noMipmap,isCompressed,
samplingMode)):scene&&scene.removePendingData(texture))}_setupFramebufferDepthAttachments(generateStencilBuffer,generateDepthBuffer,width,height,samples=1){const gl=this._gl;return generateStencilBuffer&&generateDepthBuffer?this._createRenderBuffer(width,height,samples,gl.DEPTH_STENCIL,gl.DEPTH24_STENCIL8,gl.DEPTH_STENCIL_ATTACHMENT):generateDepthBuffer?(generateStencilBuffer=gl.DEPTH_COMPONENT16,1<this._webGLVersion&&(generateStencilBuffer=gl.DEPTH_COMPONENT32F),this._createRenderBuffer(width,height,
samples,generateStencilBuffer,generateStencilBuffer,gl.DEPTH_ATTACHMENT)):generateStencilBuffer?this._createRenderBuffer(width,height,samples,gl.STENCIL_INDEX8,gl.STENCIL_INDEX8,gl.STENCIL_ATTACHMENT):null}_createRenderBuffer(width,height,samples,internalFormat,msInternalFormat,attachment,unbindBuffer=!0){const renderBuffer=this._gl.createRenderbuffer();return this._updateRenderBuffer(renderBuffer,width,height,samples,internalFormat,msInternalFormat,attachment,unbindBuffer)}_updateRenderBuffer(renderBuffer,
width,height,samples,internalFormat,msInternalFormat,attachment,unbindBuffer=!0){const gl=this._gl;gl.bindRenderbuffer(gl.RENDERBUFFER,renderBuffer);1<samples&&gl.renderbufferStorageMultisample?gl.renderbufferStorageMultisample(gl.RENDERBUFFER,samples,msInternalFormat,width,height):gl.renderbufferStorage(gl.RENDERBUFFER,internalFormat,width,height);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,attachment,gl.RENDERBUFFER,renderBuffer);unbindBuffer&&gl.bindRenderbuffer(gl.RENDERBUFFER,null);return renderBuffer}_releaseTexture(texture){var _a;
this._deleteTexture(null===(_a=texture._hardwareTexture)||void 0===_a?void 0:_a.underlyingResource);this.unbindAllTextures();_a=this._internalTexturesCache.indexOf(texture);-1!==_a&&this._internalTexturesCache.splice(_a,1);texture._lodTextureHigh&&texture._lodTextureHigh.dispose();texture._lodTextureMid&&texture._lodTextureMid.dispose();texture._lodTextureLow&&texture._lodTextureLow.dispose();texture._irradianceTexture&&texture._irradianceTexture.dispose()}_releaseRenderTargetWrapper(rtWrapper){rtWrapper=
this._renderTargetWrapperCache.indexOf(rtWrapper);-1!==rtWrapper&&this._renderTargetWrapperCache.splice(rtWrapper,1)}_deleteTexture(texture){texture&&this._gl.deleteTexture(texture)}_setProgram(program){this._currentProgram!==program&&(this._gl.useProgram(program),this._currentProgram=program)}bindSamplers(effect){var webGLPipelineContext=effect.getPipelineContext();this._setProgram(webGLPipelineContext.program);webGLPipelineContext=effect.getSamplers();for(let index=0;index<webGLPipelineContext.length;index++){const uniform=
effect.getUniform(webGLPipelineContext[index]);uniform&&(this._boundUniforms[index]=uniform)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(target,texture,forTextureDataUpdate=!1,force=!1){var _a,_b;let wasPreviouslyBound=!1;const isTextureForRendering=texture&&-1<texture._associatedChannel;forTextureDataUpdate&&
isTextureForRendering&&(this._activeChannel=texture._associatedChannel);if(this._boundTexturesCache[this._activeChannel]!==texture||force){this._activateCurrentTexture();if(texture&&texture.isMultiview)throw console.error(target,texture),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(target,null!==(_b=null===(_a=null===texture||void 0===texture?void 0:texture._hardwareTexture)||void 0===_a?void 0:_a.underlyingResource)&&void 0!==_b?_b:null);if(this._boundTexturesCache[this._activeChannel]=
texture)texture._associatedChannel=this._activeChannel}else forTextureDataUpdate&&(wasPreviouslyBound=!0,this._activateCurrentTexture());isTextureForRendering&&!forTextureDataUpdate&&this._bindSamplerUniformToChannel(texture._associatedChannel,this._activeChannel);return wasPreviouslyBound}_bindTexture(channel,texture,name){void 0!==channel&&(texture&&(texture._associatedChannel=channel),this._activeChannel=channel,channel=texture?this._getTextureTarget(texture):this._gl.TEXTURE_2D,this._bindTextureDirectly(channel,
texture))}unbindAllTextures(){for(let channel=0;channel<this._maxSimultaneousTextures;channel++)this._activeChannel=channel,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),1<this.webGLVersion&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(channel,uniform,texture,name){void 0!==channel&&(uniform&&(this._boundUniforms[channel]=uniform),this._setTexture(channel,texture))}_bindSamplerUniformToChannel(sourceSlot,
destination){(sourceSlot=this._boundUniforms[sourceSlot])&&sourceSlot._currentState!==destination&&(this._gl.uniform1i(sourceSlot,destination),sourceSlot._currentState=destination)}_getTextureWrapMode(mode){switch(mode){case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(channel,texture,isPartOfTextureArray=!1,depthStencilTexture=!1,name){if(!texture)return null!=this._boundTexturesCache[channel]&&(this._activeChannel=channel,this._bindTextureDirectly(this._gl.TEXTURE_2D,
null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),1<this.webGLVersion&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(texture.video){this._activeChannel=channel;if(name=texture.getInternalTexture())name._associatedChannel=channel;texture.update()}else if(4===texture.delayLoadState)return texture.delayLoad(),!1;depthStencilTexture=depthStencilTexture?texture.depthStencilTexture:texture.isReady()?texture.getInternalTexture():
texture.isCube?this.emptyCubeTexture:texture.is3D?this.emptyTexture3D:texture.is2DArray?this.emptyTexture2DArray:this.emptyTexture;!isPartOfTextureArray&&depthStencilTexture&&(depthStencilTexture._associatedChannel=channel);name=!0;this._boundTexturesCache[channel]===depthStencilTexture&&(isPartOfTextureArray||this._bindSamplerUniformToChannel(depthStencilTexture._associatedChannel,channel),name=!1);this._activeChannel=channel;channel=this._getTextureTarget(depthStencilTexture);name&&this._bindTextureDirectly(channel,
depthStencilTexture,isPartOfTextureArray);depthStencilTexture&&!depthStencilTexture.isMultiview&&(depthStencilTexture.isCube&&depthStencilTexture._cachedCoordinatesMode!==texture.coordinatesMode&&(depthStencilTexture._cachedCoordinatesMode=texture.coordinatesMode,isPartOfTextureArray=3!==texture.coordinatesMode&&5!==texture.coordinatesMode?1:0,texture.wrapU=isPartOfTextureArray,texture.wrapV=isPartOfTextureArray),depthStencilTexture._cachedWrapU!==texture.wrapU&&(depthStencilTexture._cachedWrapU=
texture.wrapU,this._setTextureParameterInteger(channel,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(texture.wrapU),depthStencilTexture)),depthStencilTexture._cachedWrapV!==texture.wrapV&&(depthStencilTexture._cachedWrapV=texture.wrapV,this._setTextureParameterInteger(channel,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(texture.wrapV),depthStencilTexture)),depthStencilTexture.is3D&&depthStencilTexture._cachedWrapR!==texture.wrapR&&(depthStencilTexture._cachedWrapR=texture.wrapR,this._setTextureParameterInteger(channel,
this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(texture.wrapR),depthStencilTexture)),this._setAnisotropicLevel(channel,depthStencilTexture,texture.anisotropicFilteringLevel));return!0}setTextureArray(channel,uniform,textures,name){if(void 0!==channel&&uniform){this._textureUnits&&this._textureUnits.length===textures.length||(this._textureUnits=new Int32Array(textures.length));for(name=0;name<textures.length;name++){const texture=textures[name].getInternalTexture();texture?(this._textureUnits[name]=
channel+name,texture._associatedChannel=channel+name):this._textureUnits[name]=-1}this._gl.uniform1iv(uniform,this._textureUnits);for(channel=0;channel<textures.length;channel++)this._setTexture(this._textureUnits[channel],textures[channel],!0)}}_setAnisotropicLevel(target,internalTexture,anisotropicFilteringLevel){const anisotropicFilterExtension=this._caps.textureAnisotropicFilterExtension;11!==internalTexture.samplingMode&&3!==internalTexture.samplingMode&&2!==internalTexture.samplingMode&&(anisotropicFilteringLevel=
1);anisotropicFilterExtension&&internalTexture._cachedAnisotropicFilteringLevel!==anisotropicFilteringLevel&&(this._setTextureParameterFloat(target,anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(anisotropicFilteringLevel,this._caps.maxAnisotropy),internalTexture),internalTexture._cachedAnisotropicFilteringLevel=anisotropicFilteringLevel)}_setTextureParameterFloat(target,parameter,value,texture){this._bindTextureDirectly(target,texture,!0,!0);this._gl.texParameterf(target,parameter,
value)}_setTextureParameterInteger(target,parameter,value,texture){texture&&this._bindTextureDirectly(target,texture,!0,!0);this._gl.texParameteri(target,parameter,value)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let i=0;i<this._caps.maxVertexAttribs;i++)this.disableAttributeByIndex(i)}else for(let i=0,ul=this._vertexAttribArraysEnabled.length;i<ul;i++)i>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[i]||this.disableAttributeByIndex(i)}releaseEffects(){for(const name in this._compiledEffects){const webGLPipelineContext=
this._compiledEffects[name].getPipelineContext();this._deletePipelineContext(webGLPipelineContext)}this._compiledEffects={}}dispose(){var _a;this._isDisposed=!0;this.stopRenderLoop();this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear();this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null);this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null);this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer);
this.releaseEffects();null===(_a=this.releaseComputeEffects)||void 0===_a?void 0:_a.call(this);this.unbindAllAttributes();this._boundUniforms={};(0,_domManagement.IsWindowObjectExist)()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile));this._workingContext=this._workingCanvas=
null;this._currentBufferPointers.length=0;this._boundRenderFunction=this._currentProgram=this._renderingCanvas=null;_effect.Effect.ResetCache();for(const request of this._activeRequests)request.abort();this.onDisposeObservable.notifyObservers(this);this.onDisposeObservable.clear()}attachContextLostEvent(callback){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",callback,!1)}attachContextRestoredEvent(callback){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",
callback,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return 1<this._webGLVersion?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return 1<this._webGLVersion?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(type){const gl=this._gl;for(;gl.getError()!==gl.NO_ERROR;);let successful=!0;const texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(type),
1,1,0,gl.RGBA,this._getWebGLTextureType(type),null);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);type=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,type);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(successful=(successful=successful&&status===gl.FRAMEBUFFER_COMPLETE)&&gl.getError()===gl.NO_ERROR)gl.clear(gl.COLOR_BUFFER_BIT),
successful=successful&&gl.getError()===gl.NO_ERROR;if(successful){gl.bindFramebuffer(gl.FRAMEBUFFER,null);status=gl.RGBA;const readType=gl.UNSIGNED_BYTE,buffer=new Uint8Array(4);gl.readPixels(0,0,1,1,status,readType,buffer);successful=successful&&gl.getError()===gl.NO_ERROR}gl.deleteTexture(texture);gl.deleteFramebuffer(type);for(gl.bindFramebuffer(gl.FRAMEBUFFER,null);!successful&&gl.getError()!==gl.NO_ERROR;);return successful}_getWebGLTextureType(type){if(1===this._webGLVersion){switch(type){case 1:return this._gl.FLOAT;
case 2:return this._gl.HALF_FLOAT_OES;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(type){case 3:return this._gl.BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;
case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(format,useSRGBBuffer=!1){let internalFormat=useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA;switch(format){case 0:internalFormat=this._gl.ALPHA;
break;case 1:internalFormat=this._gl.LUMINANCE;break;case 2:internalFormat=this._gl.LUMINANCE_ALPHA;break;case 6:internalFormat=this._gl.RED;break;case 7:internalFormat=this._gl.RG;break;case 4:internalFormat=useSRGBBuffer?this._glSRGBExtensionValues.SRGB:this._gl.RGB;break;case 5:internalFormat=useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA}if(1<this._webGLVersion)switch(format){case 8:internalFormat=this._gl.RED_INTEGER;break;case 9:internalFormat=this._gl.RG_INTEGER;break;
case 10:internalFormat=this._gl.RGB_INTEGER;break;case 11:internalFormat=this._gl.RGBA_INTEGER}return internalFormat}_getRGBABufferInternalSizedFormat(type,format,useSRGBBuffer=!1){if(1===this._webGLVersion){if(void 0!==format)switch(format){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return useSRGBBuffer?this._glSRGBExtensionValues.SRGB:this._gl.RGB}return this._gl.RGBA}switch(type){case 3:switch(format){case 6:return this._gl.R8_SNORM;
case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(format){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return useSRGBBuffer?this._glSRGBExtensionValues.SRGB8:this._gl.RGB8;case 5:return useSRGBBuffer?this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;
case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(format){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(format){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;
default:return this._gl.RGBA16UI}case 6:switch(format){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(format){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(format){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;
default:return this._gl.RGBA32F}case 2:switch(format){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(format){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return useSRGBBuffer?
this._glSRGBExtensionValues.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(type,format=5){switch(type){case 1:switch(format){case 6:return this._gl.R32F;default:return this._gl.RGBA32F}case 2:switch(format){case 6:return this._gl.R16F;default:return this._gl.RGBA16F}}return this._gl.RGBA8}_loadFile(url,onSuccess,onProgress,offlineProvider,useArrayBuffer,onError){url=ThinEngine._FileToolsLoadFile(url,onSuccess,onProgress,offlineProvider,useArrayBuffer,onError);this._activeRequests.push(url);
url.onCompleteObservable.add(request=>{this._activeRequests.splice(this._activeRequests.indexOf(request),1)});return url}static _FileToolsLoadFile(url,onSuccess,onProgress,offlineProvider,useArrayBuffer,onError){throw(0,_devTools._WarnImport)("FileTools");}readPixels(x,y,width,height,hasAlpha=!0,flushRenderer=!0){const format=hasAlpha?this._gl.RGBA:this._gl.RGB;hasAlpha=new Uint8Array(height*width*(hasAlpha?4:3));flushRenderer&&this.flushFramebuffer();this._gl.readPixels(x,y,width,height,format,this._gl.UNSIGNED_BYTE,
hasAlpha);return Promise.resolve(hasAlpha)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(null!==this._HasMajorPerformanceCaveat)return!this._HasMajorPerformanceCaveat;if(null===this._IsSupported)try{const tempcanvas=this._CreateCanvas(1,1);this._IsSupported=null!=(tempcanvas.getContext("webgl")||tempcanvas.getContext("experimental-webgl"))&&!!window.WebGLRenderingContext}catch(e){this._IsSupported=
!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(null===this._HasMajorPerformanceCaveat)try{const tempcanvas=this._CreateCanvas(1,1);this._HasMajorPerformanceCaveat=!(tempcanvas.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||tempcanvas.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0}))}catch(e){this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(x){x--;x|=x>>1;x|=x>>2;x|=x>>4;x|=x>>8;x|=x>>16;x++;return x}static FloorPOT(x){x|=
x>>1;x|=x>>2;x|=x>>4;x|=x>>8;x|=x>>16;return x-(x>>1)}static NearestPOT(x){const c=ThinEngine.CeilingPOT(x),f=ThinEngine.FloorPOT(x);return c-x>x-f?f:c}static GetExponentOfTwo(value,max,mode=2){switch(mode){case 1:value=ThinEngine.FloorPOT(value);break;case 2:value=ThinEngine.NearestPOT(value);break;default:value=ThinEngine.CeilingPOT(value)}return Math.min(value,max)}static QueueNewFrame(func,requester){if((0,_domManagement.IsWindowObjectExist)()){const {requestPostAnimationFrame,requestAnimationFrame}=
requester||window;if("function"===typeof requestPostAnimationFrame)return requestPostAnimationFrame(func);if("function"===typeof requestAnimationFrame)return requestAnimationFrame(func)}else if("function"===typeof requestAnimationFrame)return requestAnimationFrame(func);return setTimeout(func,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:(0,_domManagement.IsDocumentAvailable)()?document:null}}exports.ThinEngine=ThinEngine;
ThinEngine.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,
targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];ThinEngine._TextureLoaders=
[];ThinEngine.CollisionsEpsilon=.001;ThinEngine._IsSupported=null;ThinEngine._HasMajorPerformanceCaveat=null}
//# sourceMappingURL=module$node_modules$$babylonjs$core$Engines$thinEngine.js.map
